
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>JSONEditor with forms</title>
    <link rel="stylesheet" href="bootstrap.min.css">
</head>
<body>
<div class="container">
    <p>
        The form is set to send a <code>GET</code> request to the same page.
        A change event listener has been added to the editor so that whenever the form changes, the editor value
        is stored in a hidden input using <code>JSON.stringify()</code>.
    </p>

    <p>
        The option <code>use_name_attributes</code> was set to <code>false</code>
        to avoid sending the other field with the request.
    </p>
    <p>
        When the form is submitted only the hidden input is sent in the request.
        This allows to send data structures like arrays and object.
        Also the same schema that is used to build the form can be used as parameter to backend json validators tools.
        Try yourself, submit the form and look in the network tab of the developer tool.
    </p>
    <div class="form-group"></div>
    <!-- <form action="/docs/form-submission.html" method="get"> -->
        <!-- <input id="input" type="hidden" name="json"> -->
				<!-- <textarea id="input" name="json" rows="10" cols="50"></textarea> -->
        <!-- <div id='editor-container'></div> -->
        <!-- <input id="submit" class="btn btn-primary" width="100" type="submit"> -->
    <!-- </form> -->

		<form action='/api/config' method='post' id='config'>
			<input type='hidden' name='config' value='configuration'>
			<div id='editor-container'></div>
			<button id='save' type='button' class="btn btn-primary" width="100">Save</button> <!-- do not use type='submit' as ajax is to be used -->
		</form>
		
		<hr>
		
		<form action='/restart' method='get'>
			<button id='restart' type='button' class="btn btn-primary" width="100">Restart</button>
		</form>

		<form action='/reset_wifi' method='get'>
			<button id='reset_wifi' type='button' class="btn btn-primary" width="100">Reset Wifi</button>
		</form>

    <br>
		<div> 
		<p><b>Real-time Json-form (synchronized with the form settings:</b></p>
		<textarea id="post" name="json" rows="10" cols="100"></textarea>
		</div>
		
		<div>
		<p><b>Set form with json strings:<b><button id='setvalue'>Set Form</button></p>
		<textarea id="input" name="json" rows="10" cols="100"></textarea>
		</div>

		<div>
		<p><b>Web response:</b></p>
		<div id='status' style="color:red"></div>
		<textarea id="output" name="json_received" rows="10" cols="100"></textarea>
		</div>
		
		<br>
    <h2>Get params</h2>
    <pre id="get-params"></pre>
</div>

<script>

var config = `%CONFIG%`;

/*
var config = `
{
	"module":"Demo",
	"wifi": {
		"ssid":"ESky",
		"pass":"Hcjwin66"
	},
	"ip":"",
	"gateway":"",
	"otapass":"Hcjmosaic@66",
  "mqtt":{
		"server":"raspberrypi.local",
		"port":1883,
		"user":"cjjiot",
		"pass":"Hcjmosaic@66"
	},
  "sensors":[
	 {"type":"HC-SR04","name":"sr04","pins": ["D1","D2"]},
	 {"type":"VL53L0X","name":"vl53"},
	 {"type":"DHT11","name":"dh11","pins":["D5"]}
	]
}
`;
*/

var form = document.getElementById('config')

var save = document.getElementById('save')
save.onclick = function(event){
        var xhr = new XMLHttpRequest()
        var formData = new FormData(form)
        //open the request
        xhr.open(form.method, form.action, true)
        xhr.setRequestHeader("Content-Type", "application/json")

        //send the form data, NOTE form has more data than editor, send editor json instead!!
        //xhr.send(JSON.stringify(Object.fromEntries(formData)))
				xhr.send(JSON.stringify(editor.getValue()))

        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                // form.reset() //reset form after AJAX success or do something else
								document.getElementById('status').innerHTML = 'Submitted'
								document.getElementById('output').value = xhr.responseText
            }
        }
        //Fail the onsubmit to avoid page refresh.
        // return false; 
    }
		
var restart = document.getElementById('restart')
restart.onclick = function(event){
        var xhr = new XMLHttpRequest()
        //open the request
        xhr.open('get', '/restart', true)
        xhr.setRequestHeader("Content-Type", "text/plain")

				xhr.send()

        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                // form.reset() //reset form after AJAX success or do something else
								// document.getElementById('status').innerHTML = 'Submitted'
								document.getElementById('output').value = xhr.responseText
            }
        }
        //Fail the onsubmit to avoid page refresh.
        // return false; 
    }

var reset_wifi = document.getElementById('reset_wifi')
reset_wifi.onclick = function(event){
        var xhr = new XMLHttpRequest()
        //open the request
        xhr.open('get', '/reset_wifi', true)
        xhr.setRequestHeader("Content-Type", "text/plain")

				xhr.send()

        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                // form.reset() //reset form after AJAX success or do something else
								// document.getElementById('status').innerHTML = 'Submitted'
								document.getElementById('output').value = xhr.responseText
            }
        }
        //Fail the onsubmit to avoid page refresh.
        // return false; 
    }

</script>

<script src="jsoneditor.min.js"></script>
<script>
  var params = {}
  for (const [key, value] of new URLSearchParams(window.location.search).entries()) {
    params[key] = value
    console.log(key, value)
  }
  document.querySelector('#get-params').textContent = JSON.stringify(params, null, 2)
  var schema = {
    use_name_attributes: false,
    theme: 'bootstrap4',
    disable_edit_json: true,
    disable_properties: true,
    disable_collapse: true,
    schema: {
      'title': 'ESP Device Setup',
      'type': 'object',
      'required': [
        'module',
        'wifi',
				'mqtt',
        'sensors'
      ],
      'properties': {
        'module': {
					'title': 'Module',
          'type': 'string',
          'description': 'Module name, used as dns name for OTA and ssid in AP mode.',
          'minLength': 4,
          'default': 'ESP8266'
        },
        'wifi': {
          'type': 'object',
          'title': 'WiFi',
          'properties': {
            'ssid': {
							'title': 'SSID',
              'type': 'string',
              'default': 'ESky'
            },
            'pass': {
							'title': 'Password',
              'type': 'string',
              'default': ''
            }
          }
        },
				'ip': {
					'title': 'Static IP',
					'type': 'string',
					'default': '192.168.0.190'
				},
				'gateway': {
					'title': 'Gateway',
					'type': 'string',
					'default': ''
				},
				'otapass': {
					'title': 'OTA pass',
					'type': 'string',
					'default': ''
				},
        'mqtt': {
          'type': 'object',
          'title': 'MQTT',
          'properties': {
            'server': {
							'title': 'Server',
              'type': 'string',
              'default': 'raspberrypi.local'
            },
            'port': {
							'title': 'Port',
              'type': 'integer',
              'default': 1883
            },
            'serverport': {
              'type': 'string',
              'description': 'This is generated automatically from the previous two fields',
              'template': '{{server}}:{{port}}',
              'watch': {
                'server': 'mqtt.server',
                'port': 'mqtt.port'
              }
            },
            'user': {
							'title': 'User',
              'type': 'string',
              'default': 'cjjiot'
            },						
            'pass': {
              'type': 'string',
              'default': ''
            }
          }
        },
        'sensors': {
          'type': 'array',
          'format': 'table',
          'title': 'Sensors',
          'uniqueItems': true,
          'items': {
            'type': 'object',
            'title': 'Sensor',
            'properties': {
              'type': {
                'type': 'string',
                'enum': [
                  'HC-SR04',
                  'VL53L0X',
                  'DHT11'
                ],
                'default': ''
              },
              'name': {
                'type': 'string'
              },
							'pins': {
                'type': 'array',
								'format': 'table',
								'items': {
									'type': 'string',
									'enum': [
										'D0',
										'D1',
										'D2',
										'D3',
										'D4',
										'D5',
										'D6',
										'D7',
										'D8',
										'D9',
										'RX',
										'TX'
									],
									'default': ''
								}
              }
            }
					}
        }
      }
    }
  }

  var editor = new JSONEditor(document.querySelector('#editor-container'), schema)

	document.getElementById('setvalue').onclick = function(event){
		editor.setValue(JSON.parse(document.getElementById('input').value))
	}

  
	editor.on('ready', function () {
    // editor.setValue(config); // set the config
		// document.querySelector('#input').value = config
		editor.setValue(JSON.parse(config))
  })
  
	editor.on('change', function () {
    document.querySelector('#post').value = JSON.stringify(editor.getValue())
  })
</script>
</body>
</html>
